name: Build & Test

on:
  push:
    branches:
      - main
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # e.g. 0.6.1
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.config.runner }}
    strategy:
      fail-fast: false
      matrix:
        python: ['3.9', '3.10', '3.11', '3.12']
        config:
        - os: linux
          arch: x64
          runner: ubuntu-22.04
        # macOS disabled: wheels exceed PyPI size limit
        # - os: macos
        #   arch: arm64
        #   runner: macos-14
    defaults:
      run:
        shell: bash -el {0}
    steps:
    - uses: actions/checkout@v4
      with:
        path: ws/src/tesseract_nanobind
    - name: brew (macOS)
      if: matrix.config.os == 'macos'
      run: |
        brew install libomp automake autoconf libtool
    - name: cache conda env
      uses: actions/cache@v4
      id: conda-cache
      with:
        path: ~/miniconda3/envs
        key: conda-v2-py${{ matrix.python }}-${{ matrix.config.os }}-${{ matrix.config.arch }}-${{ hashFiles('ws/src/tesseract_nanobind/tesseract_nanobind/environment.yml') }}
    - uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
        activate-environment: tesseract_nb
        environment-file: ws/src/tesseract_nanobind/tesseract_nanobind/environment.yml
        python-version: ${{ matrix.python }}
        use-mamba: true
    - name: cache vcs repos
      uses: actions/cache@v4
      with:
        path: |
          ws/src/tesseract
          ws/src/tesseract_planning
          ws/src/trajopt
          ws/src/descartes_light
          ws/src/opw_kinematics
          ws/src/ruckig
        key: vcs-${{ hashFiles('ws/src/tesseract_nanobind/dependencies.rosinstall') }}
    - name: vcs import
      working-directory: ws/src
      run: vcs import --input tesseract_nanobind/dependencies.rosinstall --skip-existing
    - name: cache colcon build
      uses: actions/cache@v4
      id: colcon-cache
      with:
        path: ws/install
        key: colcon-v5-py${{ matrix.python }}-${{ matrix.config.os }}-${{ matrix.config.arch }}-${{ hashFiles('ws/src/tesseract_nanobind/dependencies.rosinstall') }}
    - name: colcon build C++ deps (macOS)
      if: matrix.config.os == 'macos' && steps.colcon-cache.outputs.cache-hit != 'true'
      working-directory: ws
      run: |
        export DYLD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib
        export CMAKE_PREFIX_PATH=$CONDA_PREFIX:$GITHUB_WORKSPACE/ws/install
        export LIBRARY_PATH=$CONDA_PREFIX/lib:$LIBRARY_PATH
        export CMAKE_POLICY_VERSION_MINIMUM=3.5

        colcon build --merge-install \
            --packages-ignore tesseract_python tesseract_examples trajopt_ifopt trajopt_sqp ifopt vhacd qpoases osqp_eigen tesseract_nanobind tesseract_viewer_python \
            --event-handlers console_cohesion+ \
            --cmake-force-configure \
            --cmake-args -GNinja -DCMAKE_BUILD_TYPE=Release \
            -DINSTALL_OMPL=OFF -DINSTALL_OMPL_TAG=master -DBUILD_IPOPT=OFF -DBUILD_SNOPT=OFF \
            -DBUILD_SHARED_LIBS=ON -DTESSERACT_ENABLE_EXAMPLES=OFF -DTESSERACT_BUILD_TRAJOPT_IFOPT=OFF \
            -DTESSERACT_ENABLE_TESTING=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DQT_HOST_PATH=$CONDA_PREFIX \
            -DOpenMP_CXX_INCLUDE_DIR=/opt/homebrew/opt/libomp/include \
            -DOpenMP_C_INCLUDE_DIR=/opt/homebrew/opt/libomp/include \
            -DOpenMP_CXX_LIB_NAMES=libomp -DOpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp" \
            -DOpenMP_C_LIB_NAMES=libomp -DOpenMP_C_FLAGS="-Xpreprocessor -fopenmp" \
            -DOpenMP_libomp_LIBRARY=/opt/homebrew/opt/libomp/lib/libomp.dylib
    - name: colcon build C++ deps (Linux)
      if: matrix.config.os == 'linux' && steps.colcon-cache.outputs.cache-hit != 'true'
      working-directory: ws
      run: |
        export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib
        export CMAKE_PREFIX_PATH=$CONDA_PREFIX:$GITHUB_WORKSPACE/ws/install
        export LIBRARY_PATH=$CONDA_PREFIX/lib:$LIBRARY_PATH
        export CMAKE_POLICY_VERSION_MINIMUM=3.5

        colcon build --merge-install \
            --packages-ignore tesseract_python tesseract_examples trajopt_ifopt trajopt_sqp ifopt vhacd qpoases osqp_eigen tesseract_nanobind tesseract_viewer_python \
            --event-handlers console_cohesion+ \
            --cmake-force-configure \
            --cmake-args -GNinja -DCMAKE_BUILD_TYPE=Release \
            -DINSTALL_OMPL=OFF -DINSTALL_OMPL_TAG=master -DBUILD_IPOPT=OFF -DBUILD_SNOPT=OFF \
            -DBUILD_SHARED_LIBS=ON -DTESSERACT_ENABLE_EXAMPLES=OFF -DTESSERACT_BUILD_TRAJOPT_IFOPT=OFF \
            -DTESSERACT_ENABLE_TESTING=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    - name: build nanobind wheel (macOS)
      if: matrix.config.os == 'macos'
      working-directory: ws/src/tesseract_nanobind/tesseract_nanobind
      run: |
        export DYLD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib
        export CMAKE_PREFIX_PATH=$CONDA_PREFIX:$GITHUB_WORKSPACE/ws/install
        pip install delocate setuptools-scm
        CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0" \
          pip wheel . -w dist/ --no-build-isolation
    - name: build nanobind wheel (Linux)
      if: matrix.config.os == 'linux'
      working-directory: ws/src/tesseract_nanobind/tesseract_nanobind
      run: |
        export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib
        export CMAKE_PREFIX_PATH=$CONDA_PREFIX:$GITHUB_WORKSPACE/ws/install
        pip install auditwheel setuptools-scm
        CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5" \
          pip wheel . -w dist/ --no-build-isolation
    - name: delocate (macOS)
      if: matrix.config.os == 'macos'
      working-directory: ws/src/tesseract_nanobind/tesseract_nanobind
      run: |
        export DYLD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib:/opt/homebrew/opt/libomp/lib
        mkdir -p wheelhouse
        delocate-wheel -w wheelhouse -v dist/*.whl
    - name: auditwheel (Linux)
      if: matrix.config.os == 'linux'
      working-directory: ws/src/tesseract_nanobind/tesseract_nanobind
      run: |
        export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$GITHUB_WORKSPACE/ws/install/lib
        mkdir -p wheelhouse
        # Only repair tesseract wheel, exclude numpy
        auditwheel repair dist/tesseract*.whl -w wheelhouse --plat auto
    - name: test
      run: |
        # Install from dist for testing (wheelhouse may have higher glibc reqs)
        python -m pip install ws/src/tesseract_nanobind/tesseract_nanobind/dist/tesseract*.whl --force-reinstall
        # Reinstall numpy from conda-forge to fix BLAS compatibility on macOS
        # (PyPI numpy 2.3.5 uses NEWLAPACK symbols not available on macOS-14)
        mamba install -y numpy --force-reinstall
        # Set library path for native libs (LD for Linux, DYLD for macOS)
        export LD_LIBRARY_PATH=$GITHUB_WORKSPACE/ws/install/lib:$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
        export DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/ws/install/lib:$CONDA_PREFIX/lib:$DYLD_LIBRARY_PATH
        # TESSERACT_SUPPORT_DIR, TESSERACT_RESOURCE_PATH, TESSERACT_TASK_COMPOSER_CONFIG_FILE
        # are now auto-set by tesseract_robotics.__init__.py using bundled data
        cd ws/src/tesseract_nanobind/tesseract_nanobind
        pytest tests/tesseract_command_language tests/tesseract_common -v
    - name: archive wheels
      uses: actions/upload-artifact@v4
      with:
        name: 'python-${{ matrix.python }}-${{ matrix.config.os }}-${{ matrix.config.arch }}'
        path: ws/src/tesseract_nanobind/tesseract_nanobind/wheelhouse/tesseract*.whl
    - name: archive logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: 'build-logs-${{ matrix.config.os }}-${{ matrix.config.arch }}'
        path: "**/*.log"
        retention-days: 2

  publish:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
    - uses: actions/download-artifact@v4
      with:
        pattern: python-*-linux-*  # TODO: change back to python-* after PyPI size limit increase
        merge-multiple: true
        path: dist/
    - name: List wheels
      run: ls -la dist/
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
