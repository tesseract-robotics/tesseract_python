
message(STATUS "Running install_build_wheel.cmake")

if(WIN32)
execute_process(COMMAND @PYTHON_EXECUTABLE@ setup.py bdist_wheel WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
file(GLOB wheel_files "${CMAKE_CURRENT_LIST_DIR}/python/dist/*.whl")
foreach(wheel_file ${wheel_files})
execute_process(COMMAND @PYTHON_EXECUTABLE@ -m delvewheel repair --no-dll msvcp140.dll\;vcomp140.dll ${wheel_file} WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
endforeach()

elseif(APPLE)
execute_process(COMMAND @PYTHON_EXECUTABLE@ setup.py bdist_wheel WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
file(GLOB wheel_files "${CMAKE_CURRENT_LIST_DIR}/python/dist/*.whl")
foreach(wheel_file ${wheel_files})
execute_process(COMMAND delocate-wheel --sanitize-rpaths -d -w ${CMAKE_CURRENT_LIST_DIR}/python/wheelhouse ${wheel_file} WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
endforeach()
else()
execute_process(COMMAND @PYTHON_EXECUTABLE@ setup.py bdist_wheel --plat-name=@TESSERACT_PYTHON_WHEEL_PLATFORM@ WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
file(GLOB wheel_files "${CMAKE_CURRENT_LIST_DIR}/python/dist/*.whl")
foreach(wheel_file ${wheel_files})
execute_process(COMMAND @PYTHON_EXECUTABLE@ -m auditwheel repair --plat @TESSERACT_PYTHON_WHEEL_PLATFORM@ ${wheel_file} WORKING_DIRECTORY python RESULT_VARIABLE STATUS)
if(STATUS AND NOT STATUS EQUAL 0)
  message(FATAL_ERROR "Python Build Wheel Failed: ${STATUS}")
endif()
endforeach()
endif()